<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Takip</title>
<script>
  // Eƒüer sayfa PWA (standalone) olarak a√ßƒ±lmƒ±≈üsa zoom'u kapat
  if (window.matchMedia('(display-mode: standalone)').matches ||
      window.navigator.standalone === true) {
    const meta = document.querySelector('meta[name=viewport]');
    if (meta) {
      meta.setAttribute('content', 'width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no');
    }
  }
</script>

<style>
  .btn {
    flex: 1;
    min-width: 90px;
    min-height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,.08);
    background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.15));
    transition: transform 0.15s ease, background 0.25s ease;
    cursor: pointer;
  }

  :root { --bg:#0f1115; --card:#151923; --txt:#e6e7ea; --muted:#9aa0aa; --bar:#2a3040; --barFill:#21c27a; }
  html,body{height:100%}

  html, body { height:auto; }
  .card { overflow: visible; } /* g√ºvenli: i√ßerik kesilmesin */

  body{
    margin:0;
    font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background:var(--bg);
    color:var(--txt);
    /* iOS √ßentiƒüi i√ßin: */
    padding-top: calc(env(safe-area-inset-top, 0px) + 10px);
    min-height: 100dvh; /* mobilde ger√ßek viewport y√ºksekliƒüi */
  }

  .wrap{
    width:100%;
    max-width:820px;
    padding: 16px 24px 24px 24px;
    margin: 0 auto; /* ortalamayƒ± buradan yap */
  }

  .card{background:var(--card);border-radius:18px;padding:28px;box-shadow:0 10px 30px rgba(0,0,0,.35);
        display:flex;flex-direction:column;gap:22px}
  .top{display:flex;gap:18px;flex-wrap:wrap;align-items:center;justify-content:space-between}
  .clock{font-size:38px;font-weight:800}
  .date{font-size:13px;color:var(--muted);margin-top:-6px}
  .buttons{display:flex;gap:14px;flex-wrap:wrap}
  .btn{flex:1;min-width:140px;padding:16px 0;border-radius:14px;border:1px solid rgba(255,255,255,.08);
       font-size:20px;font-weight:800;cursor:pointer}
  .btn:active{transform:translateY(1px);filter:brightness(.95)}
  .btn:disabled{opacity:.55;cursor:not-allowed}
  .btn018{background:linear-gradient(180deg,rgba(94,200,255,.18),rgba(94,200,255,.08));color:#d6efff}
  .btn02{background:linear-gradient(180deg,rgba(94,200,255,.18),rgba(94,200,255,.08));color:#d6efff}
  .btn05{background:linear-gradient(180deg,rgba(94,200,255,.18),rgba(94,200,255,.08));color:#d6efff}
  .btn075{background:linear-gradient(180deg,rgba(94,200,255,.18),rgba(94,200,255,.08));color: #d6efff}

  .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .stat{background:rgba(255,255,255,.04);border-radius:12px;padding:12px;text-align:center}
  .stat .lab{font-size:12px;color:var(--muted)}
  .stat .val{font-size:22px;font-weight:800}
  .meter{height:12px;background:#2a3040;border-radius:999px;overflow:hidden;width:100%;
         box-shadow:inset 0 0 0 1px rgba(255,255,255,.06)}
  .meter>span{display:block;height:100%;width:0%;background:var(--barFill);transition:width .25s ease}
  canvas{background:transparent;border-radius:12px}
  .muted{color:var(--muted);font-size:12px;text-align:center}

  /* Ripple & k√º√ß√ºk animasyonlar (opsiyonel) */
  .btn{ position:relative; overflow:hidden; }
  .ripple{ position:absolute; border-radius:50%; pointer-events:none; transform:scale(0); opacity:.5; background:#fff; mix-blend-mode:overlay; animation:ripple .6s ease-out forwards; }
  @keyframes ripple{ to{ transform:scale(12); opacity:0; } }
  .btn.pulse{ animation:pulse .18s ease; } @keyframes pulse{ 50%{ transform:translateY(1px) scale(.98); } }
  .meter.flash{ box-shadow: 0 0 0 2px rgba(33,194,122,.35), inset 0 0 12px rgba(33,194,122,.35); }

  /* ‚úÖ Ba≈üarƒ±lƒ± ekleme pop-up */
  .ok-pop {
    position: fixed; inset: 0; display: none; place-items: center; z-index: 9999;
    background: rgba(0,0,0,.35); backdrop-filter: blur(2px);
  }
  .ok-pop.show { display: grid; }

  .ok-card {
    background: #11161e; border: 1px solid rgba(255,255,255,.08);
    border-radius: 16px; padding: 18px 22px; min-width: 220px;
    display: flex; align-items: center; gap: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,.4);
    animation: ok-pop-in .18s ease-out both;
  }
  @keyframes ok-pop-in { from { transform: scale(.96); opacity: 0 } to { transform: scale(1); opacity: 1 } }

  .ok-tick {
    width: 28px; height: 28px; border-radius: 50%;
    background: rgba(33,194,122,.15); border: 1px solid rgba(33,194,122,.5);
    display: grid; place-items: center; color: #21c27a; flex: 0 0 auto;
  }
  .ok-text { color: #e6e7ea; font-weight: 700; font-size: 15px; line-height: 1.2; }
  .ok-sub  { color: #9aa0aa; font-size: 12px; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <div id="clock" class="clock">--:--:--</div>
          <div id="date" class="date">----------</div>
        </div>
      </div>

      <div class="buttons">

        <button id="btn018" class="btn btn018" disabled data-val="0.18">
          <img src="./images/cup.webp"  alt="+0.18 L" width="60" height="70" loading="lazy">
        </button>
        
        <button id="btn02" class="btn btn02" disabled data-val="0.2">
          <img src="./images/glass.webp"  alt="+0.2 L" width="45" height="65" loading="lazy">
        </button>

        <button id="btn05" class="btn btn05" disabled data-val="0.5">
          <img src="./images/bottle.webp" alt="+0.5 L" width="50" height="95" loading="lazy">
        </button>

        <button id="btn075" class="btn btn075" disabled data-val="0.75">
          <img src="./images/tupper.webp" alt="+0.75 L" width="85" height="110" loading="lazy" />
        </button>

        
      </div>

      <div class="stats">
        <div class="stat"><div class="lab">Bug√ºn i√ßilen</div><div id="todaySum" class="val">0.0 L</div></div>
        <div class="stat"><div class="lab">Kalan</div><div id="remain" class="val">0.0 L</div></div>
        <div class="stat"><div class="lab">G√ºnl√ºk hedef</div><div id="goalView" class="val">2.5 L</div></div>
      </div>

      <div class="meter"><span id="bar"></span></div>

      <div class="stats">
        <div class="stat"><div class="lab">Son 7 g√ºn</div><div id="weekSum" class="val">0.0 L</div></div>
        <div class="stat"><div class="lab">Bu ay</div><div id="monthSum" class="val">0.0 L</div></div>
      </div>

      <canvas id="chart7" height="170"></canvas>
      <div class="muted">‚ö†Ô∏è √áevrimdƒ±≈üƒ± olduƒüunda veri giri≈üi kapalƒ±dƒ±r.</div>
    </div>
  </div>

  <!-- ‚úÖ Ba≈üarƒ±lƒ± i≈ülem pop-up -->
  <div id="okPop" class="ok-pop" aria-live="polite" aria-hidden="true">
    <div class="ok-card" role="status">
      <div class="ok-tick" aria-hidden="true">
        <!-- Basit tik svg -->
        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
          <path d="M9 16.2 4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4z"/>
        </svg>
      </div>
      <div>
        <div id="okText" class="ok-text">Kayƒ±t eklendi</div>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script type="module">
  import { firebaseConfig, authCredentials } from "./config.js";

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    initializeFirestore, collection, addDoc, query, where, onSnapshot, getDocs
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import {
    getAuth, onAuthStateChanged,
    signInWithEmailAndPassword,
    setPersistence, browserLocalPersistence
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  // Sabit hedef
  const DAILY_GOAL_L = 2.5;

  // Firebase
  const app = initializeApp(firebaseConfig);
  const db  = initializeFirestore(app, { experimentalForceLongPolling:true, useFetchStreams:false });
  const auth= getAuth(app);

  // UI refs
  const $ = id => document.getElementById(id);
  const elClock=$('clock'), elDate=$('date'), elGoalView=$('goalView'),
        elToday=$('todaySum'), elRemain=$('remain'), elBar=$('bar'),
        elWeek=$('weekSum'), elMonth=$('monthSum'), meterEl=document.querySelector('.meter'),
        btn018=$('btn018'),btn02=$('btn02'), btn05=$('btn05'), btn075=$('btn075');

  // ‚úÖ Pop-up g√∂ster/gizle
  let okTimer = null;
  function showOkPopup(message = "Kayƒ±t eklendi") {
    const pop = document.getElementById('okPop');
    const txt = document.getElementById('okText');
    if (!pop || !txt) return;

    txt.textContent = message;
    pop.classList.add('show');
    pop.setAttribute('aria-hidden', 'false');

    // üîí Butonlarƒ± kilitle
    btn018.disabled = true;
    btn02.disabled = true;
    btn05.disabled = true;
    btn075.disabled = true;

    if (okTimer) clearTimeout(okTimer);
    okTimer = setTimeout(hideOkPopup, 2000);
  }
  function hideOkPopup() {
    const pop = document.getElementById('okPop');
    if (!pop) return;
    pop.classList.remove('show');
    pop.setAttribute('aria-hidden', 'true');

    // üîì Pop-up kapandƒ±ktan sonra butonlarƒ± tekrar aktif et (online + UID ise)
    setButtonsByState();
  };


  // Saat
  const pad = n => n.toString().padStart(2,'0');
  const todayISO = () => { const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; };
  const timeNow  = () => { const d=new Date(); return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; };
  function tickClock(){ const d=new Date();
    elClock.textContent = `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    elDate.textContent  = `${todayISO()} ‚Ä¢ ` + new Intl.DateTimeFormat('tr-TR',{dateStyle:'full'}).format(d);
  }
  setInterval(tickClock,1000); tickClock();
  elGoalView.textContent = `${DAILY_GOAL_L.toFixed(1)} L`;

  // Online/UID'a g√∂re buton kontrol√º
  let UID = null;
  function setButtonsByState() {
    const enable = navigator.onLine && !!UID;
    btn018.disabled  = !enable;
    btn02.disabled  = !enable;
    btn05.disabled  = !enable;
    btn075.disabled = !enable;
  }
  window.addEventListener("online",  setButtonsByState);
  window.addEventListener("offline", setButtonsByState);

  // Ripple & mini animasyon
  function addRipple(e) {
    const btn = e.currentTarget;
    const rect = btn.getBoundingClientRect();
    const span = document.createElement('span');
    const size = Math.max(rect.width, rect.height);
    span.className = 'ripple';
    span.style.width = span.style.height = size + 'px';
    span.style.left = (e.clientX - rect.left - size/2) + 'px';
    span.style.top  = (e.clientY - rect.top  - size/2) + 'px';
    btn.appendChild(span);
    setTimeout(()=> span.remove(), 650);
    btn.classList.add('pulse'); setTimeout(()=> btn.classList.remove('pulse'), 200);
  }
  function flashBar(){ meterEl.classList.add('flash'); setTimeout(()=> meterEl.classList.remove('flash'), 250); }

  // Auth: tek kullanƒ±cƒ±yla otomatik giri≈ü
  async function autoSignIn() {
    try {
      await setPersistence(auth, browserLocalPersistence);
      await signInWithEmailAndPassword(auth, authCredentials.email, authCredentials.password);
      // ba≈üarƒ±lƒ±ysa onAuthStateChanged √ßalƒ±≈üƒ±r
    } catch (e) {
      console.error("Otomatik giri≈ü ba≈üarƒ±sƒ±z:", e);
      alert("Giri≈ü ba≈üarƒ±sƒ±z: " + (e.message || e.code || e));
    }
  }
  autoSignIn();

  onAuthStateChanged(auth, async (user)=>{
    if (!user) { UID = null; setButtonsByState(); return; }
    UID = user.uid;
    setButtonsByState();
    await attachTodayListener();
    if (navigator.onLine) await refreshAggregatesAndChart();
  });

  // Yazma (sadece online + UID varsa)
  async function addValue(litres){
    if (!navigator.onLine) { alert("√áevrimdƒ±≈üƒ±! Baƒülantƒ± gelince deneyin."); return; }
    if (!UID) { alert("Baƒülantƒ± kuruluyor, l√ºtfen tekrar deneyin."); return; }
    setButtonsByState(); // kƒ±sa kilitleme

    try{
      await addDoc(collection(db,'kayitlar'), {
        uid: UID, tarih: todayISO(), saat: timeNow(), eklenen_deger: litres
      });
      flashBar();
      // ‚úÖ ba≈üarƒ±lƒ± ‚Üí pop-up g√∂ster ve 3 sn kilitli kalsƒ±n
      showOkPopup(`+${litres.toFixed(2)} L eklendi`);
    } catch(e){
      alert("Kayƒ±t eklenemedi: " + (e.message || e));
      // hata varsa butonlarƒ± tekrar deƒüerlendir
      setButtonsByState();
    }
  }
  btn018.onclick  = (e)=>{ addRipple(e); addValue(0.18);  };
  btn02.onclick  = (e)=>{ addRipple(e); addValue(0.2);  };
  btn05.onclick  = (e)=>{ addRipple(e); addValue(0.5);  };
  btn075.onclick = (e)=>{ addRipple(e); addValue(0.75); };

  // Bug√ºn√ºn toplamƒ±nƒ± dinle
  let unsubToday=null, chart7=null;
  async function attachTodayListener(){
    if (typeof unsubToday==='function'){ unsubToday(); unsubToday=null; }
    const q=query(collection(db,'kayitlar'), where('uid','==',UID), where('tarih','==',todayISO()));
    unsubToday=onSnapshot(q,snap=>{
      let sum=0; snap.forEach(doc=> sum += Number(doc.data().eklenen_deger)||0 );
      elToday.textContent = `${sum.toFixed(1)} L`;
      const remain = Math.max(0, DAILY_GOAL_L - sum);
      elRemain.textContent = `${remain.toFixed(1)} L`;
      elBar.style.width = `${Math.min(100, DAILY_GOAL_L>0 ? (sum/DAILY_GOAL_L)*100 : 0)}%`;
    });
  }

  // Son 7 g√ºn / Bu ay
  async function refreshAggregatesAndChart(){
    if (!UID) return;
    const snap = await getDocs(query(collection(db,'kayitlar'), where('uid','==', UID)));
    const all = snap.docs.map(d=>d.data());
    const map = new Map(); let weekSum=0, monthSum=0;
    const now=new Date(), today=todayISO();
    const startWeek=(()=>{const d=new Date(); d.setDate(d.getDate()-6); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;})();
    const startMonth=`${now.getFullYear()}-${pad(now.getMonth()+1)}-01`;
    for (const r of all){
      const v = Number(r.eklenen_deger)||0;
      map.set(r.tarih,(map.get(r.tarih)||0)+v);
      if (r.tarih>=startWeek && r.tarih<=today) weekSum += v;
      if (r.tarih>=startMonth && r.tarih<=today) monthSum += v;
    }
    $('weekSum').textContent = `${weekSum.toFixed(1)} L`;
    $('monthSum').textContent= `${monthSum.toFixed(1)} L`;

    const labels=[], data=[];
    for (let i=29;i>=0;i--){
      const d=new Date(); d.setDate(d.getDate()-i);
      const key = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      labels.push(key.slice(5)); // "MM-DD"
      const v = Number(map.get(key) || 0);
      data.push(+v.toFixed(1));  // ‚úÖ sayƒ± olarak (√∂r. 1.2)
    }
    draw30Days(labels, data);
  }
  setInterval(()=>{ if(UID && navigator.onLine) refreshAggregatesAndChart(); }, 60000);

  // --- Son 30 g√ºn grafiƒüi: hedefin altƒ± kƒ±rmƒ±zƒ± ---
  function draw30Days(labels, data) {
    const ctx = document.getElementById('chart7');
    if (chart7) chart7.destroy();

    chart7 = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Son 30 G√ºn (L)',
          data,
          backgroundColor: (ctx) => {
            const val = ctx.parsed.y;
            return val < DAILY_GOAL_L ? 'rgba(255, 99, 132, 0.8)' : 'rgba(33, 194, 122, 0.8)';
          },
          borderColor: (ctx) => {
            const val = ctx.parsed.y;
            return val < DAILY_GOAL_L ? 'rgba(255, 99, 132, 1)' : 'rgba(33, 194, 122, 1)';
          },
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { grid: { color: 'rgba(255,255,255,.06)' }, ticks: { color: '#cfd5df' } },
          y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,.06)' }, ticks: { color: '#cfd5df' } }
        }
      }
    });
  }
</script>
</body>
</html>
