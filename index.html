<script type="module">
  import { firebaseConfig, authCredentials } from "./config.js";

  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  // ðŸ”» Firestore importlarÄ±nÄ± TEK satÄ±rda topla (Ã§ift import yok)
  import {
    getFirestore, initializeFirestore,
    collection, addDoc, query, where, onSnapshot, getDocs
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import {
    getAuth, onAuthStateChanged,
    signInWithEmailAndPassword,
    setPersistence, browserLocalPersistence
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  // ---- Chart.js'i Dinamik YÃ¼kle (modÃ¼l iÃ§inde) ----
  let Chart; // global ref
  async function ensureChartJs() {
    if (!Chart) {
      const mod = await import("https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js");
      Chart = mod.Chart;
    }
  }

  // Sabit hedef
  const DAILY_GOAL_L = 2.5;

  // Firebase
  const app = initializeApp(firebaseConfig);

  // HÄ±zlÄ± yol: getFirestore; gerekirse fallback long-polling
  let db;
  try {
    db = getFirestore(app);
  } catch {
    db = initializeFirestore(app, { experimentalForceLongPolling:true, useFetchStreams:false });
  }
  const auth= getAuth(app);

  // UI refs
  const $ = id => document.getElementById(id);
  const elClock=$('clock'), elDate=$('date'), elGoalView=$('goalView'),
        elToday=$('todaySum'), elRemain=$('remain'), elBar=$('bar'),
        elWeek=$('weekSum'), elMonth=$('monthSum'), meterEl=document.querySelector('.meter'),
        btn02=$('btn02'), btn05=$('btn05');

  // Saat
  const pad = n => n.toString().padStart(2,'0');
  const todayISO = () => { const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; };
  const timeNow  = () => { const d=new Date(); return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; };
  function tickClock(){ const d=new Date();
    elClock.textContent = `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    elDate.textContent  = `${todayISO()} â€¢ ` + new Intl.DateTimeFormat('tr-TR',{dateStyle:'full'}).format(d);
  }
  setInterval(tickClock,1000); tickClock();
  elGoalView.textContent = `${DAILY_GOAL_L.toFixed(1)} L`;

  // Online/UID'a gÃ¶re buton kontrolÃ¼
  let UID = null, unsubToday=null, chart7=null;
  function setButtonsByState() {
    const enable = navigator.onLine && !!UID;
    btn02.disabled = !enable;
    btn05.disabled = !enable;
  }
  window.addEventListener("online",  setButtonsByState);
  window.addEventListener("offline", setButtonsByState);

  // Ripple & mini animasyon
  function addRipple(e) {
    const btn = e.currentTarget;
    const rect = btn.getBoundingClientRect();
    const span = document.createElement('span');
    const size = Math.max(rect.width, rect.height);
    span.className = 'ripple';
    span.style.width = span.style.height = size + 'px';
    span.style.left = (e.clientX - rect.left - size/2) + 'px';
    span.style.top  = (e.clientY - rect.top  - size/2) + 'px';
    btn.appendChild(span);
    setTimeout(()=> span.remove(), 650);
    btn.classList.add('pulse'); setTimeout(()=> btn.classList.remove('pulse'), 200);
  }
  function flashBar(){ meterEl.classList.add('flash'); setTimeout(()=> meterEl.classList.remove('flash'), 250); }

  // Auth: tek kullanÄ±cÄ±yla otomatik giriÅŸ
  async function autoSignIn() {
    try {
      await setPersistence(auth, browserLocalPersistence);
      await signInWithEmailAndPassword(auth, authCredentials.email, authCredentials.password);
    } catch (e) {
      console.error("Otomatik giriÅŸ baÅŸarÄ±sÄ±z:", e);
      alert("GiriÅŸ baÅŸarÄ±sÄ±z: " + (e.message || e.code || e));
    }
  }
  autoSignIn();

  onAuthStateChanged(auth, async (user)=>{
    if (!user) { UID = null; setButtonsByState(); return; }
    UID = user.uid;
    setButtonsByState();
    await attachTodayListener();
    if (navigator.onLine) await refreshAggregatesAndChart();
  });

  // Yazma (sadece online + UID varsa)
  async function addValue(litres){
    if (!navigator.onLine) { alert("Ã‡evrimdÄ±ÅŸÄ±! BaÄŸlantÄ± gelince deneyin."); return; }
    if (!UID) { alert("BaÄŸlantÄ± kuruluyor, lÃ¼tfen tekrar deneyin."); return; }
    setButtonsByState(); // kÄ±sa kilitleme
    try{
      await addDoc(collection(db,'kayitlar'), {
        uid: UID, tarih: todayISO(), saat: timeNow(), eklenen_deger: litres
      });
      flashBar();
      await refreshAggregatesAndChart(); // periyodik yerine olay bazlÄ± yenile
    } catch(e){
      alert("KayÄ±t eklenemedi: " + (e.message || e));
    } finally {
      setButtonsByState();
    }
  }
  btn02.onclick = (e)=>{ addRipple(e); addValue(0.2); };
  btn05.onclick = (e)=>{ addRipple(e); addValue(0.5); };

  // BugÃ¼nÃ¼n toplamÄ±nÄ± dinle
  async function attachTodayListener(){
    if (typeof unsubToday==='function'){ unsubToday(); unsubToday=null; }
    const q=query(collection(db,'kayitlar'), where('uid','==',UID), where('tarih','==',todayISO()));
    unsubToday=onSnapshot(q,snap=>{
      let sum=0; snap.forEach(doc=> sum += Number(doc.data().eklenen_deger)||0 );
      elToday.textContent = `${sum.toFixed(1)} L`;
      const remain = Math.max(0, DAILY_GOAL_L - sum);
      elRemain.textContent = `${remain.toFixed(1)} L`;
      elBar.style.width = `${Math.min(100, DAILY_GOAL_L>0 ? (sum/DAILY_GOAL_L)*100 : 0)}%`;
    });
  }

  // Son 30 gÃ¼n / Bu ay
  async function refreshAggregatesAndChart(){
    if (!UID) return;

    // Chart.js'i tam burada yÃ¼kle (ilk boyama sonrasÄ±)
    await ensureChartJs();

    // (performans iÃ§in istersen tarih aralÄ±ÄŸÄ± ekleyebilirsin)
    const snap = await getDocs(query(collection(db,'kayitlar'), where('uid','==', UID)));
    const all = snap.docs.map(d=>d.data());
    const map = new Map(); let weekSum=0, monthSum=0;
    const now=new Date(), today=todayISO();
    const startWeek=(()=>{const d=new Date(); d.setDate(d.getDate()-6); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;})();
    const startMonth=`${now.getFullYear()}-${pad(now.getMonth()+1)}-01`;
    for (const r of all){
      const v = Number(r.eklenen_deger)||0;
      map.set(r.tarih,(map.get(r.tarih)||0)+v);
      if (r.tarih>=startWeek && r.tarih<=today) weekSum += v;
      if (r.tarih>=startMonth && r.tarih<=today) monthSum += v;
    }
    $('weekSum').textContent = `${weekSum.toFixed(1)} L`;
    $('monthSum').textContent= `${monthSum.toFixed(1)} L`;

    const labels=[], data=[];
    for (let i=29;i>=0;i--){
      const d=new Date(); d.setDate(d.getDate()-i);
      const key = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      labels.push(key.slice(5)); // "MM-DD"
      const v = Number(map.get(key) || 0);
      data.push(+v.toFixed(1));  // sayÄ± olarak
    }
    draw30Days(labels, data);
  }

  // --- Son 30 gÃ¼n grafiÄŸi: hedefin altÄ± kÄ±rmÄ±zÄ± ---
  function draw30Days(labels, data) {
    const ctx = document.getElementById('chart7');
    if (chart7) chart7.destroy();

    chart7 = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Son 30 GÃ¼n (L)',
          data,
          backgroundColor: (ctx) => {
            const val = ctx.parsed.y;
            return val < DAILY_GOAL_L ? 'rgba(255, 99, 132, 0.8)' : 'rgba(33, 194, 122, 0.8)';
          },
          borderColor: (ctx) => {
            const val = ctx.parsed.y;
            return val < DAILY_GOAL_L ? 'rgba(255, 99, 132, 1)' : 'rgba(33, 194, 122, 1)';
          },
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { grid: { color: 'rgba(255,255,255,.06)' }, ticks: { color: '#cfd5df' } },
          y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,.06)' }, ticks: { color: '#cfd5df' } }
        }
      }
    });
  }

  // Ä°stersen periyodik tazelemeyi kaldÄ±rÄ±p sadece add sonrasÄ± yeniliyoruz.
  // setInterval(()=>{ if(UID && navigator.onLine) refreshAggregatesAndChart(); }, 60000);
</script>
