<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Takip – Zeynep</title>

<!-- PWA modunda yakınlaştırmayı kapat -->
<script>
  if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
    const meta = document.querySelector('meta[name=viewport]');
    if (meta) meta.setAttribute('content','width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no');
  }
</script>

<style>
  :root { --bg:#0f1115; --card:#151923; --txt:#e6e7ea; --muted:#9aa0aa; --bar:#2a3040; --barFill:#21c27a; }

  html, body { height:auto; }
  body{
    margin:0;
    font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background:var(--bg);
    color:var(--txt);
    min-height: 100dvh;
    display:flex; align-items:center; justify-content:center;
    padding:
      calc(env(safe-area-inset-top, 0px) + 6px)
      calc(env(safe-area-inset-right, 0px) + 10px)
      calc(env(safe-area-inset-bottom, 0px) + 4px)
      calc(env(safe-area-inset-left, 0px) + 10px);
  }

  .wrap{ width:100%; max-width:820px; padding:16px 24px 24px; margin:0; }
  .card{ background:var(--card); border-radius:18px; padding:28px; box-shadow:0 10px 30px rgba(0,0,0,.35);
         display:flex; flex-direction:column; gap:22px; overflow:visible; }
  .top{ display:flex; gap:18px; flex-wrap:wrap; align-items:center; justify-content:space-between }
  .clock{ font-size:38px; font-weight:800 }
  .date{ font-size:13px; color:var(--muted); margin-top:-6px }

  .buttons{ display:flex; gap:14px; flex-wrap:wrap }

  /* .btn tek tanım */
  .btn{
    flex:1; min-width:140px; min-height:110px;
    display:flex; align-items:center; justify-content:center;
    flex-direction: column;
    justify-content: flex-start;
    gap: 6px;
    border-radius:14px; border:1px solid rgba(255,255,255,.08);
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.15));
    transition: transform .15s ease, background .25s ease;
    cursor:pointer;
    position:relative; overflow:hidden;
    font-size:20px; font-weight:800;
  }
  .btn-label {
  font-size: 13px;
  font-weight: 600;
  color: var(--muted);
  letter-spacing: 0.2px;
  user-select: none;
  margin-top: 4px;
}
  .btn:active{ transform:translateY(1px); filter:brightness(.95) }
  .btn:disabled{ opacity:.55; cursor:not-allowed }

  .btn02,.btn04,.btn05{
    background:linear-gradient(180deg,rgba(94,200,255,.18),rgba(94,200,255,.08)); color:#d6efff
  }

  .btn img { width:65px; height:auto; max-height:90px; object-fit:contain; pointer-events:none; }
  @media (min-width:768px){ .btn img{ width:75px; max-height:100px; } }

  .stats{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px }
  .stat{ background:rgba(255,255,255,.04); border-radius:12px; padding:12px; text-align:center }
  .stat .lab{ font-size:12px; color:var(--muted) }
  .stat .val{ font-size:22px; font-weight:800 }

  .meter{ height:12px; background:#2a3040; border-radius:999px; overflow:hidden; width:100%;
          box-shadow:inset 0 0 0 1px rgba(255,255,255,.06) }
  .meter>span{ display:block; height:100%; width:0%; background:var(--barFill); transition:width .25s ease }
  .meter.flash{ box-shadow: 0 0 0 2px rgba(33,194,122,.35), inset 0 0 12px rgba(33,194,122,.35) }

  canvas{ background:transparent; border-radius:12px }
  .muted{ color:var(--muted); font-size:12px; text-align:center }

  /* Ripple animasyonu */
  .ripple{ position:absolute; border-radius:50%; pointer-events:none; transform:scale(0); opacity:.5; background:#fff; mix-blend-mode:overlay; animation:ripple .6s ease-out forwards; }
  @keyframes ripple{ to{ transform:scale(12); opacity:0; } }
  .btn.pulse{ animation:pulse .18s ease; } @keyframes pulse{ 50%{ transform:translateY(1px) scale(.98); } }

  /* ✅ Pop-up */
  .ok-pop{ position:fixed; inset:0; display:none; place-items:center; z-index:9999; background:rgba(0,0,0,.35); backdrop-filter:blur(2px) }
  .ok-pop.show{ display:grid }
  .ok-card{ background:#11161e; border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:18px 22px; min-width:220px;
            display:flex; align-items:center; gap:12px; box-shadow:0 10px 30px rgba(0,0,0,.4); animation:ok-pop-in .18s ease-out both }
  @keyframes ok-pop-in{ from{ transform:scale(.96); opacity:0 } to{ transform:scale(1); opacity:1 } }
  .ok-tick{ width:28px; height:28px; border-radius:50%; background:rgba(33,194,122,.15); border:1px solid rgba(33,194,122,.5);
            display:grid; place-items:center; color:#21c27a; flex:0 0 auto }
  .ok-text{ color:#e6e7ea; font-weight:700; font-size:15px; line-height:1.2 }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <div id="clock" class="clock">--:--:--</div>
          <div id="date" class="date">----------</div>
        </div>

        <div id="weatherCard" style="text-align:right; font-size:16px; font-weight:700;">
          <span id="locationName" style="font-size:13px; color:var(--muted);">Konum</span><br>
          <span id="tempValue">--°C</span>
        </div>
      </div>

      <div class="buttons">
        
        <button id="btn02" class="btn btn02" disabled data-val="0.2">
          <img src="./images/glass.webp"  alt="+0.2 L" width="15" height="30" loading="lazy">
          <span class="btn-label">Küçük Bardak L</span>
        </button>
        
        <button id="btn04" class="btn btn04" disabled data-val="0.4">
          <img src="./images/glass.webp"  alt="+0.4 L" width="30" height="60" loading="lazy">
          <span class="btn-label">Büyük Bardak L</span>
        </button>
        
        <button id="btn05" class="btn btn05" disabled data-val="0.5">
          <img src="./images/bottle_3.webp" alt="+0.5 L" width="45" height="125" loading="lazy">
          <span class="btn-label">0,5 Şişe</span>
        </button>
        
      </div>

      <div class="stats">
        <div class="stat"><div class="lab">Bugün içilen</div><div id="todaySum" class="val">0.0 L</div></div>
        <div class="stat"><div class="lab">Kalan</div><div id="remain" class="val">0.0 L</div></div>
        <div class="stat"><div class="lab">Günlük hedef</div><div id="goalView" class="val">3.1 L</div></div>
      </div>

      <div class="meter"><span id="bar"></span></div>

      <div class="stats">
        <div class="stat"><div class="lab">Son 7 gün</div><div id="weekSum" class="val">0.0 L</div></div>
        <div class="stat"><div class="lab">Bu ay</div><div id="monthSum" class="val">0.0 L</div></div>
      </div>

      <canvas id="chart30" height="170"></canvas>
      <div class="muted">⚠️ Çevrimdışı olduğunda veri girişi kapalıdır....</div>
    </div>
  </div>

  <!-- ✅ Başarılı işlem pop-up -->
  <div id="okPop" class="ok-pop" aria-live="polite" aria-hidden="true">
    <div class="ok-card" role="status">
      <div class="ok-tick" aria-hidden="true">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
          <path d="M9 16.2 4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4z"/>
        </svg>
      </div>
      <div><div id="okText" class="ok-text">Kayıt eklendi</div></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script type="module">
    import { firebaseConfig, authProfiles, weatherConfig } from "./config.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { initializeFirestore, collection, addDoc, query, where, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    /* --------- Sabitler --------- */
    const PROFIL = 'zeynep';
    const COL    = 'kayitlar_zeynep';
    const DAILY_GOAL_L = 3.1;

    /* --------- Firebase --------- */
    const app  = initializeApp(firebaseConfig);
    const db   = initializeFirestore(app, { experimentalForceLongPolling:true, useFetchStreams:false });
    const auth = getAuth(app);

    /* --------- UI refs --------- */
    const $ = id => document.getElementById(id);
    const elClock=$('clock'), elDate=$('date'), elGoalView=$('goalView'),
          elToday=$('todaySum'), elRemain=$('remain'), elBar=$('bar'),
          elWeek=$('weekSum'), elMonth=$('monthSum'), meterEl=document.querySelector('.meter'),
          btn02=$('btn02'), btn04=$('btn04'), btn05=$('btn05');
    const elTemp = $('tempValue'), elLocation = $('locationName');

    /* --------- Hava durumu (opsiyonel) --------- */
    async function fetchWeather() {
      const { apiKey, city } = weatherConfig;
      if (!apiKey) { elLocation.textContent = "API Key Eksik"; return; }
      try {
        const url = `https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${apiKey}&units=metric&lang=tr`;
        const res = await fetch(url);
        if (!res.ok) throw new Error("API hatası: " + res.statusText);
        const data = await res.json();
        elLocation.textContent = data.name;
        elTemp.textContent = `${Math.round(data.main.temp)}°C`;
      } catch (e) {
        console.error(e);
        elLocation.textContent = (weatherConfig.city || "Konum").split(',')[0];
        elTemp.textContent = "--°C";
      }
    }
    fetchWeather();
    setInterval(fetchWeather, 900000); // 15 dk

    /* --------- Saat --------- */
    const pad = n => String(n).padStart(2,'0');
    const todayISO = () => { const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; };
    const timeNow  = () => { const d=new Date(); return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`; };
    function tickClock(){ const d=new Date();
      elClock.textContent = `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      elDate.textContent  = `${todayISO()} • ` + new Intl.DateTimeFormat('tr-TR',{dateStyle:'full'}).format(d);
    }
    setInterval(tickClock,1000); tickClock();
    elGoalView.textContent = `${DAILY_GOAL_L.toFixed(1)} L`;

    /* --------- Online/UID --------- */
    let UID = null, unsubToday = null, chart30 = null;
    function setButtonsByState() {
      const enable = navigator.onLine && !!UID;
      btn02.disabled = btn04.disabled = btn05.disabled = !enable;
    }
    addEventListener('online',  setButtonsByState);
    addEventListener('offline', setButtonsByState);

    /* --------- Ripple & bar flash --------- */
    function addRipple(e){
      const btn=e.currentTarget, rect=btn.getBoundingClientRect(), span=document.createElement('span'), size=Math.max(rect.width,rect.height);
      span.className='ripple'; span.style.width=span.style.height=size+'px';
      span.style.left=(e.clientX-rect.left-size/2)+'px'; span.style.top=(e.clientY-rect.top-size/2)+'px';
      btn.appendChild(span); setTimeout(()=>span.remove(),650);
      btn.classList.add('pulse'); setTimeout(()=>btn.classList.remove('pulse'),200);
    }
    function flashBar(){ meterEl.classList.add('flash'); setTimeout(()=> meterEl.classList.remove('flash'), 250); }

    /* --------- Pop-up --------- */
    let okTimer = null;
    function showOkPopup(msg="Kayıt eklendi"){
      const pop=$('okPop'), txt=$('okText'); if(!pop||!txt) return;
      txt.textContent=msg; pop.classList.add('show'); pop.setAttribute('aria-hidden','false');
      btn02.disabled = btn04.disabled = btn05.disabled = true;
      if (okTimer) clearTimeout(okTimer); okTimer = setTimeout(hideOkPopup, 2000);
    }
    function hideOkPopup(){
      const pop=$('okPop'); if(!pop) return;
      pop.classList.remove('show'); pop.setAttribute('aria-hidden','true'); setButtonsByState();
    }

    /* --------- Auth --------- */
    async function autoSignIn() {
      try {
        await setPersistence(auth, browserLocalPersistence);
        const cred = authProfiles[PROFIL];
        await signInWithEmailAndPassword(auth, cred.email, cred.password);
      } catch (e) {
        console.error("Otomatik giriş başarısız:", e);
        alert("Giriş başarısız: " + (e.message || e.code || e));
      }
    }
    autoSignIn();

    onAuthStateChanged(auth, async (user)=>{
      if (!user) { UID = null; setButtonsByState(); return; }
      UID = user.uid;
      setButtonsByState();
      await attachTodayListener();
      if (navigator.onLine) await refreshAggregatesAndChart();
    });

    /* --------- Yazma --------- */
    async function addValue(litres){
      if (!navigator.onLine) { alert("Çevrimdışı!"); return; }
      if (!UID) { alert("Bağlantı kuruluyor..."); return; }
      setButtonsByState();
      try{
        await addDoc(collection(db, COL), {
          uid: UID,
          owner: PROFIL,
          tarih: todayISO(),
          saat: timeNow(),
          eklenen_deger: litres
        });
        flashBar(); showOkPopup(`+${litres.toFixed(2)} L eklendi`);
      } catch(e){
        alert("Kayıt eklenemedi: " + (e.message || e));
        setButtonsByState();
      }
    }
    btn02.onclick   = (e)=>{ addRipple(e); addValue(0.2);  };
    btn04.onclick   = (e)=>{ addRipple(e); addValue(0.4);  };
    btn05.onclick  = (e)=>{ addRipple(e); addValue(0.5); };

    /* --------- Bugün dinleyici --------- */
    async function attachTodayListener(){
      if (typeof unsubToday==='function'){ unsubToday(); unsubToday=null; }
      const q = query(
        collection(db, COL),
        where('uid','==',UID),
        where('owner','==',PROFIL),
        where('tarih','==',todayISO())
      );
      unsubToday = onSnapshot(q, snap=>{
        let sum=0; snap.forEach(doc=> sum += Number(doc.data().eklenen_deger)||0 );
        elToday.textContent = `${sum.toFixed(1)} L`;
        const remain = Math.max(0, DAILY_GOAL_L - sum);
        elRemain.textContent = `${remain.toFixed(1)} L`;
        elBar.style.width = `${Math.min(100, DAILY_GOAL_L>0 ? (sum/DAILY_GOAL_L)*100 : 0)}%`;
      });
    }


    async function refreshAggregatesAndChart(){
      if (!UID) return;
      const snap = await getDocs(query(
        collection(db, COL),
        where('uid','==', UID),
        where('owner','==', PROFIL)
      ));

      const all = snap.docs.map(d=>d.data());
      const map = new Map(); let weekSum=0, monthSum=0;
      const now=new Date(), today=todayISO();
      const p2=n=>String(n).padStart(2,'0');
      const startWeek=(()=>{const d=new Date(); d.setDate(d.getDate()-6); return `${d.getFullYear()}-${p2(d.getMonth()+1)}-${p2(d.getDate())}`;})();
      const startMonth=`${now.getFullYear()}-${p2(now.getMonth()+1)}-01`;
      for (const r of all){
        const v = Number(r.eklenen_deger)||0;
        map.set(r.tarih,(map.get(r.tarih)||0)+v);
        if (r.tarih>=startWeek && r.tarih<=today) weekSum += v;
        if (r.tarih>=startMonth && r.tarih<=today) monthSum += v;
      }
      $('weekSum').textContent = `${weekSum.toFixed(1)} L`;
      $('monthSum').textContent= `${monthSum.toFixed(1)} L`;

      const labels=[], data=[];
      for (let i=29;i>=0;i--){
        const d=new Date(); d.setDate(d.getDate()-i);
        const key = `${d.getFullYear()}-${p2(d.getMonth()+1)}-${p2(d.getDate())}`;
        labels.push(key.slice(5));
        const val = Number(map.get(key) || 0);
        data.push(+val.toFixed(1));
      }
      draw30Days(labels, data);
    }
    setInterval(()=>{ if(UID && navigator.onLine) refreshAggregatesAndChart(); }, 60000);

    function draw30Days(labels, data) {
      const ctx = document.getElementById('chart30');
      if (chart30) chart30.destroy();
      chart30 = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Son 30 Gün (L)',
            data,
            backgroundColor: (c) => c.parsed.y < DAILY_GOAL_L ? 'rgba(255, 99, 132, 0.8)' : 'rgba(33, 194, 122, 0.8)',
            borderColor:     (c) => c.parsed.y < DAILY_GOAL_L ? 'rgba(255, 99, 132, 1)'   : 'rgba(33, 194, 122, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { color: 'rgba(255,255,255,.06)' }, ticks: { color: '#cfd5df' } },
            y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,.06)' }, ticks: { color: '#cfd5df' } }
          }
        }
      });
    }
  </script>
</body>
</html>






